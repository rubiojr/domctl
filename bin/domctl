#!/usr/bin/ruby
require 'rubygems'
require 'ostruct'
require 'term/ansicolor'
gem 'pangea', '~> 0.1'
require 'pangea'

debug_enabled = false

debug = ! ARGV.index('--debug').nil?
if debug
  puts 'Debugging enabled.'
  debug_enabled = true
  ARGV.delete('--debug')
end

begin
  require "#{File.join(File.dirname(__FILE__), '../lib/domctl.rb')}"
rescue
  require 'domctl'
end
require 'yaml'

include Domctl

DOMCTL_COMMANDS = {
  :cpu_utilisation => {
    :help => "domctl cpu_utilisation",
    :proc => CpuUtilisationCommand
  },
  :farm_info => {
    :help => "domctl farm_info",
    :proc => FarmInfoCommand
  },
  :mem_info => {
    :help => "domctl mem_info [host]",
    :proc => MemInfoCommand
  },
  :locate_domu => {
    :help => "domctl locate_domu <domU name>",
    :proc => LocateDomuCommand
  },
  :list_running => {
    :help => "domctl list_running <dom0_name|all>",
    :proc => ListRunningCommand
  },
  :cluster_nodes => {
    :help => "domctl cluster_nodes",
    :proc => ClusterNodesCommand
  },
  :show_vifs => {
    :help => "domctl show_vifs <[dom0_name:]domU_name>",
    :proc => ShowVifsCommand
  },
  :domu_info => {
    :help => "domctl domu_info <domU>",
    :proc => DomuInfoCommand
  },
  :dom0_info => {
    :help => "domctl dom0_info <dom0_name>",
    :proc => Dom0InfoCommand
  },
  :recent_domus => {
    :help => "domctl recent_domus",
    :proc => RecentDomusCommand
  },
  :oldest_domus => {
    :help => "domctl oldest_domus",
    :proc => OldestDomusCommand
  },
  :version => {
    :help => "domctl version",
    :proc => Proc.new { puts Domctl::VERSION }
  },
  :help => {
    :proc => HelpCommand
  }
}

trap("INT") { $stderr.puts "\nAborting."; exit }

Domctl::Config.validate
command = ARGV.shift
if command.nil? or DOMCTL_COMMANDS[command.to_sym].nil?
  HelpCommand.call 
  exit 1
end
begin
  args = ARGV
  DOMCTL_COMMANDS[command.to_sym][:args] = args
  DOMCTL_COMMANDS[command.to_sym][:proc].call
rescue SystemExit => e
  $stderr.puts "Aborting."
rescue Exception => e
  if debug_enabled
    puts e.message
    puts e.backtrace
  else
    puts "CRITICAL: #{e.message}"
  end
end

